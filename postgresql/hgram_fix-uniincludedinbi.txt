#!/bin/bash
if [ $# -ne 2 ]; then
    echo "usage"
    exit 1
fi
db=${1}
len=${2}

epoch='1hr'
psql="psql -h hops -U yaboulna -p 5433 -d ${db} -c "

echo "${psql} \"CREATE OR REPLACE FUNCTION dropUnextended(day int4) RETURNS INTEGER AS $$ \
DECLARE\
t RECORD;\
BEGIN\
FOR t in select tablename from pg_tables where tablename like 'hgram_occ_'||day||'_2_%_unextended' LOOP\
EXECUTE 'ALTER TABLE ' || quote_ident(t.tablename) || ' NO INHERIT hgram_occ_'||day||'_2';\ 
END LOOP;\ 
RETURN 0;\
END; $$ LANGUAGE plpgsql;\""

#ngramlen as ngramlen, <- can't be included in counts table

# echo "${psql} 'DROP TABLLE hgram_cnt_${epoch}${len} CASCADE'"
echo "${psql} 'CREATE TABLE hgram_cnt_${epoch}${len} (\
 date         integer, \
 epochstartux bigint, \
 ngram        text, \
 cnt          integer \
);'"
for day in 121011 121012 121013 121014 121015 121016 121017 121018 121019 121020 121021 121022 121023 121024 121025 121026 121027 121028 121029 121030 121031 121101 121102 121103 121104 121105 121106 121107 121108 121109 121110 
#120917 120918 120919 120920 120921 120922 120923 120924 120925 120926 120927 120928 120929 120930 130101 130102 130103 130104
#121001 121002 121003 121004 121005 121006 121007 121008 121009 121010 121011 121012 121013 121014 121015 121016 121017 121018 121019 121020 121021 121022 121023 121024 121025 121026 121027 121028 121029 121030 121031 
#121101 121102 121103 121104 121105 121106 121107 121108 121109 121110 121111 121112 121113 121114 121115 121116 121117 121118 121119 121120 121121 121122 121123 121124 121125 121126 121127 121128 121129 121130 
#121201 121202 121203 121204 121205 121206 121207 121208 121209 121210 121211 121212 121213 121214 121215 121216 121217 121218 121219 121220 121221 121222 121223 121224 121225 121226 121227 121228 121229 121230 121231 
do
echo "${psql} \"DROP TABLE IF EXISTS hgram_cnt_${epoch}${len}_${day};\""
echo "${psql} \"DROP TABLE IF EXISTS hgram_vol_${epoch}${len}_${day};\""

#echo "${psql} \"create table hgram_occ_uniincludedinbi_${day} as ( with bi as (select id,pos from hgram_occ_${day} where ngramlen = 2) select uni.* from hgram_occ_${day} uni join bi on bi.id=uni.id and bi.pos=uni.pos-1 where uni.ngramlen = 1);\""

echo "${psql} \"create table hgram_occ_${day}_1 () inherits (hgram_occ_${day}); \
insert into hgram_occ_${day}_1 select * from hgram_occ_${day} where ngramlen = 1 and (id,pos) not in (select id,(pos+1) from hgram_occ_${day} where ngramlen = 2); \
select dropUnextended(${day}); \
CREATE TABLE hgram_cnt_${epoch}${len}_${day} AS SELECT ${day} as date, CAST(floor(timemillis/(3600 * 1000::INT8))*(3600) AS INT8) as epochstartux, ngram, CAST(count(*) AS INT4) as cnt from hgram_occ_${day} group by ngram,epochstartux;\
CREATE INDEX hgram_cnt_${epoch}${len}_${day}_date ON hgram_cnt_${epoch}${len}_${day}(date);\
CREATE INDEX hgram_cnt_${epoch}${len}_${day}_time ON hgram_cnt_${epoch}${len}_${day}(epochstartux);\
ALTER TABLE hgram_cnt_${epoch}${len}_${day} INHERIT hgram_cnt_${epoch}${len};\
CREATE TABLE hgram_vol_${epoch}${len}_${day} AS SELECT ${day} as date, epochstartux,sum(cnt) as totalcnt from hgram_cnt_${epoch}${len}_${day} group by epochstartux;\
CREATE INDEX hgram_vol_${epoch}${len}_${day}_time ON hgram_vol_${epoch}${len}_${day}(epochstartux);\"&"

done
