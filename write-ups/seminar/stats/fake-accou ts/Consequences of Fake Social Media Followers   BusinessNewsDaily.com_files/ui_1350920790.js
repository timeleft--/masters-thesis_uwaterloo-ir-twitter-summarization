/* This source code is Copyright (c) Vibrant Media 2001-2010 and forms part of the patented Vibrant Media product "IntelliTXT" (sm). */
$iTXT.js.loader["$iTXT.ui.Aura2TooltipPlacer"]=true;$iTXT.ui.Aura2TooltipPlacer_Load=function(){$iTXT.ui.TooltipPosition={AR:"AR",AC:"AC",AL:"AL",CL:"CL",CR:"CR",BR:"BR",BC:"BC",BL:"BL"};var undefined;var posArr={};var ttps=$iTXT.ui.TooltipPosition;var debug_labels={'AR':'Above Right','CR':'Centre Right','CL':'Centre Left','AL':'Above Left','AC':'Above Centre','BL':'Below Left','BC':'Below Centre','BR':'Below Right'};$iTXT.ui.Aura2TooltipPlacer={ttOffY:5,TOPOFFSCREENWEIGHT:20,EXPTOPOFFSCREENWEIGHT:20,OFFSCREENWEIGHT:15,EXPOFFSCREENWEIGHT:2,reportWeights:function(ttps){$iTXT.debug.debug($iTXT.debug.Category.PLACER,"");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"+-------------------------------");for(var i in posArr){$iTXT.debug.debug($iTXT.debug.Category.PLACER,"+ "+debug_labels[ttps[i]]+" Weight: "+posArr[i].weight);} $iTXT.debug.debug($iTXT.debug.Category.PLACER,"+-------------------------------");},decoratedDebugHeader:function(title){$iTXT.debug.debug($iTXT.debug.Category.PLACER,"");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| "+title);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");},updateWeights:function(weight){var to_be_updated=Array.prototype.slice.call(arguments,1);if($iTXT.core.Util.isArray(to_be_updated)){to_be_updated=to_be_updated[0];} for(var i=0,len=to_be_updated.length;i<len;i++){if(posArr[to_be_updated[i]]){posArr[to_be_updated[i]].weight+=weight;}}},evalutePosition:function(rule,orient,weight,label){if(rule<0){var t_weight=weight*(rule/orient);var to_be_updated=Array.prototype.slice.call(arguments,4);this.updateWeights(t_weight,to_be_updated);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Position "+label+" are off top of screen by "+rule+"px");}},place:function(opts) {posArr={};var aura=false;var ttOffX=50;var normal=true;var ordinal=false;var aura_adj=0;if(opts.tt.currentAdvert.templateClass==="$iTXT.tmpl.js.Aura2"){aura=true;aura_adj=parseInt(opts.tt.currentAdvert.params.get("AURA2.PED.HEIGHT"),10);} var aura_top=0;var aura_right=0;$iTXT.core.$(document).itxtFire("$iTXT:tt:before:position");$iTXT.debug.info($iTXT.debug.Category.PLACER,"Placing Tooltip");if(opts.bb&&opts.tt) {if(opts.bb.target&&opts.bb.target.tagName==="SPAN"&&opts.bb.target.parentNode.tagName==="A"&&aura){var tOff=$iTXT.core.$(opts.bb.target.parentNode).itxtTotalOffset();if(opts.bb.target.parentNode.offsetHeight<39){opts.bb={left:tOff.left,top:tOff.top,height:opts.bb.target.parentNode.offsetHeight,width:opts.bb.target.parentNode.offsetWidth,target:opts.bb.target};}} var tt_width=opts.tt.width;var tt_height=opts.tt.height;var bound_box_left=opts.bb.left;var bound_box_top=opts.bb.top;var bound_box_right=opts.bb.left+opts.bb.width;var bound_box_bottom=opts.bb.top+opts.bb.height;var bound_box_width=opts.bb.width;var Pose=function(label,left,top){this.label=label;this.left=left;this.top=top;this.width=tt_width;this.height=tt_height;this.weight=0;};if(aura){normal=false;ordinal=true;aura_top=(aura_adj>40)?40:-40;aura_right=40;ttOffX=20;} var right_pos=bound_box_right-ttOffX+aura_right;var left_pos=bound_box_left-tt_width+ttOffX;var horiz_centre_pos=bound_box_left+(bound_box_width/2)-tt_width/2;var above_pos=bound_box_top-tt_height+aura_top;var below_pos=bound_box_bottom+this.ttOffY;var vert_centre_pos=bound_box_bottom-this.ttOffY-(tt_height/5)*3;if(normal){posArr[ttps.AR]=new Pose(ttps.AR,right_pos,above_pos);posArr[ttps.AL]=new Pose(ttps.AL,left_pos,above_pos);posArr[ttps.BR]=new Pose(ttps.BR,right_pos,below_pos);posArr[ttps.BL]=new Pose(ttps.BL,left_pos,below_pos);} if(ordinal){posArr[ttps.AC]=new Pose(ttps.AC,horiz_centre_pos,above_pos);posArr[ttps.CL]=new Pose(ttps.CL,left_pos,vert_centre_pos);posArr[ttps.CR]=new Pose(ttps.CR,right_pos,vert_centre_pos);posArr[ttps.BC]=new Pose(ttps.BC,horiz_centre_pos,below_pos);} $iTXT.debug.debug($iTXT.debug.Category.PLACER,"Possible Tooltip Placements:");for(var i in posArr){$iTXT.debug.debug($iTXT.debug.Category.PLACER,debug_labels[ttps[i]]+": "+$iTXT.core.Util.serialiseJSON(posArr[ttps[i]]));} var sSize=$iTXT.core.Util.getWindowSize();var dScroll=$iTXT.core.Util.getPageScroll();var sb={left:dScroll[0],top:dScroll[1],width:sSize[0],height:sSize[1]};this.decoratedDebugHeader("SCREEN OVERLAP TEST a)");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Screen Bounds: "+$iTXT.core.Util.serialiseJSON(sb));for(var i in posArr){posArr[i].weight-=100*(1-$iTXT.core.Math.intersectsPercentage(posArr[ttps[i]],sb));$iTXT.debug.debug($iTXT.debug.Category.PLACER,debug_labels[ttps[i]]+" Screen Overlap: "+($iTXT.core.Math.intersectsPercentage(posArr[ttps[i]],sb)*100)+"%");} this.reportWeights(ttps);this.decoratedDebugHeader("SCREEN OVERLAP TEST b)");this.evalutePosition(above_pos-sb.top,tt_height,this.TOPOFFSCREENWEIGHT,"Above",ttps.BR,ttps.CR);this.evalutePosition(above_pos-tt_height-sb.top,tt_height,this.EXPTOPOFFSCREENWEIGHT,"Above expanded",ttps.AR,ttps.AL,ttps.AC);this.evalutePosition(sb.left+sb.width-left_pos+tt_width,tt_width,this.OFFSCREENWEIGHT,"Right",ttps.AR,ttps.CR,ttps.BR);this.evalutePosition(sb.left+sb.width-left_pos+tt_width,tt_width,this.EXPOFFSCREENWEIGHT,"Right expanded",ttps.CR,ttps.BR);this.evalutePosition(left_pos-sb.left,tt_width,this.OFFSCREENWEIGHT,"Left",ttps.AL,ttps.CL,ttps.BL);this.evalutePosition(left_pos-sb.left-tt_width,tt_width,this.EXPOFFSCREENWEIGHT,"Left expanded",ttps.AL,ttps.CL,ttps.BL);this.evalutePosition(sb.top+sb.height-below_pos+tt_height*2,tt_height,this.OFFSCREENWEIGHT,"Below",ttps.BL,ttps.BR,ttps.BC);this.evalutePosition(sb.top+sb.height-above_pos,tt_height,this.EXPOFFSCREENWEIGHT,"Below expanded",ttps.BL,ttps.BR,ttps.BC);this.reportWeights(ttps,posArr);this.decoratedDebugHeader("SCREEN OVERLAP TEST c)");var scpos=$iTXT.core.Util.getPageScroll();var arTop=above_pos-sb.top+scpos[1];if(arTop<0) {this.updateWeights(-500,ttps.AR,ttps.AL,ttps.AC);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip header is off the top of the page when Above!!!");} this.reportWeights(ttps,posArr);this.decoratedDebugHeader("Avoidance Nodes Test");var avList=[{w:10,n:"IFRAME"},{w:10,n:"OBJECT"},{w:10,n:"EMBED"}];for(var i=0;i<avList.length;i++) {var avN=avList[i];var nLst=document.getElementsByTagName(avN.n);var nLstLen=nLst.length;$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Found "+nLstLen+" "+avN.n+" nodes");for(var i2=0;i2<nLstLen;i2++) {var nd=nLst[i2];var nbb=$iTXT.core.$(nd).itxtBounds();$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,avN.n+" node "+i2+" bounds: "+$iTXT.core.Util.serialiseJSON(nbb));for(var i in posArr){posArr[i].weight-=avN.w*($iTXT.core.Math.intersectsPercentage(posArr[ttps[i]],nbb));$iTXT.debug.debug($iTXT.debug.Category.PLACER,debug_labels[ttps[i]]+" Screen Overlap: "+($iTXT.core.Math.intersectsPercentage(posArr[ttps[i]],nbb)*100)+"%");}}} this.reportWeights(ttps,posArr);var posState=posArr[ttps.AL]||posArr[ttps.AC];for(var i in posArr){if(posArr[i].weight>posState.weight){$iTXT.debug.info($iTXT.debug.Category.PLACER,debug_labels[i]+" Has a Greater Weight");posState=posArr[i];}} if($iTXT.glob.params) {var dbgTTPS=$iTXT.glob.params.get("tt.pos.state");if(null!==dbgTTPS) {$iTXT.debug.info($iTXT.debug.Category.PLACER,"Forcing position state: "+dbgTTPS);posState=dbgTTPS;}} var returnOptions={left:posState.left,top:posState.top,state:posState.label};$iTXT.debug.info($iTXT.debug.Category.PLACER,"Return Position State: "+debug_labels[posState.label]);$iTXT.debug.info($iTXT.debug.Category.PLACER,"Return Left Position: "+returnOptions.left);$iTXT.debug.info($iTXT.debug.Category.PLACER,"Return Top Position: "+returnOptions.top);$iTXT.glob.params.set("tt.placer.value",posState.label,$iTXT.cnst.WEIGHTING_DEFAULT_CAMPAIGN);return returnOptions;}}};};$iTXT.js.loader["$iTXT.ui.ComponentBase"]=true;$iTXT.ui.ComponentBase_Load=function(){var undefined;$iTXT.ui.ComponentBase=$iTXT.core.Class.create({options:null,rootElement:null,width:undefined,height:undefined,left:undefined,top:undefined,componentParams:{},evtDspFuncs:null,init:function(_options) {this.evtDspFuncs=[];this.options=$iTXT.core.Util.extend({id:"itxtcomponent",className:""},_options);this.defaultOptions=$iTXT.core.Util.cloneObject(this.options);this.advert=this.options.advert;this.children=[];this.rootElement=$iTXT.core.Builder.make("DIV",{id:this.options.id,className:this.options.className});this.params=new $iTXT.data.Param(undefined,undefined,undefined,this.options.id);this.params.set(this.componentParams,null,$iTXT.cnst.WEIGHTING_DEFAULT_COMPONENT);this._tokenizeOptions();},dispose:function() {if(this.rootElement.parentNode) {this.rootElement.parentNode.removeChild(this.rootElement);} for(var i=0;i<this.evtDspFuncs.length;i++) {var f=this.evtDspFuncs[i];if('function'==typeof f) {f.call();}} this.evtDspFuncs=[];},resize:function() {this.setSize(this.width,this.height);},setSize:function(w,h) {this.width=w;this.height=h;this.rootElement.itxtSetStyle({width:this.width+"px",height:this.height+"px"});},setPosition:function(l,t) {this.left=l;this.top=t;this.rootElement.itxtSetStyle({left:this.left+"px",top:this.top+"px"});},getWidth:function() {return this.width||this.rootElement.offsetWidth;},getHeight:function() {return this.height||this.rootElement.offsetHeight;},getLeft:function() {return this.left||this.rootElement.offsetLeft;},getTop:function() {return this.top||this.rootElement.offsetTop;},addChild:function(childComp) {if(childComp&&childComp.rootElement) {this.children.push(childComp);this.rootElement.appendChild(childComp.rootElement);}},addChildren:function(children) {if(!children) return;for(var childComp in children) {this.addChild(children[childComp]);}},removeChild:function(childComp) {$iTXT.core.Util.without(this.children,childComp);this.rootElement.removeChild(childComp.rootElement);},show:function() {var re=$iTXT.core.$(this.rootElement);if(re){re.itxtShow();};},hide:function() {var re=$iTXT.core.$(this.rootElement);if(re){re.itxtHide();};},getHTML:function() {if(this.rootElement) {return $iTXT.core.Builder.make("DIV",{},[this.rootElement]).innerHTML;} return"";},setBackgroundColor:function(c) {this.rootElement.itxtSetStyle({backgroundColor:c});},setAdvert:function(a) {this.advert=a;this._tokenizeOptions();},changeAdvert:function(a) {this.advert=a;this._tokenizeOptions();},_tokenizeOptions:function() {if(null!=this.advert&&this.advert.params) {this.params.setParent(this.advert.params);} else if($iTXT.glob.params) {this.params.setParent($iTXT.glob.params);} this.options=$iTXT.core.Util.cloneObject(this.defaultOptions);this.options=this.params.tokenize(this.options);},tooltipOver:function() {},tooltipOut:function() {}});};$iTXT.js.loader["$iTXT.ui.Hook"]=true;$iTXT.ui.Hook_Load=function(){var undefined;var $itxtUtil=$iTXT.core.Util;function hkTrkVisibility(){var gval=$iTXT.glob.dbParams.getBool('hk.trk.visibility'),cval=$iTXT.glob.params.getBool('hk.trk.visibility');return!(cval==false||(cval==undefined&&gval==false));} $iTXT.subscribe("$iTXT:hooks:loaded",function(){var i,n,didScroll=false,masterTs=$itxtUtil.ts(),$HookMngr=$iTXT.ui.HookManager,viewportHeight=$itxtUtil.getWindowSize().height,pageHeight=$itxtUtil.getPageSize().height;if(!hkTrkVisibility()){return;} function monitor(hooks,afterTime){var i=0,n=hooks.length;for(;i<n;i++){if(!hooks[i].seenAlready){hooks[i].seenAlready=true;hooks[i].seenAfter=afterTime;$iTXT.debug.info($iTXT.debug.Category.HOOK,'Hook "'+hooks[i].keyword+'" has been seen');$iTXT.fire("$iTXT:data:log:monitor",{advert:hooks[i].ad,mt:118,mv:hooks[i].initPos.top+','+viewportHeight+','+pageHeight,mv2:afterTime});}}} for(i=0,n=$HookMngr.hooks.length;i<n;i++){$HookMngr.hooks[i].initPos=$HookMngr.hooks[i].getPosition();} monitor($HookMngr.visibleHooks(),0);$iTXT.core.$(window).itxtSubscribe('scroll',function(){didScroll=true;});setInterval(function(){if(!didScroll){return;} monitor($HookMngr.visibleHooks(),$itxtUtil.ts()-masterTs);didScroll=false;},250);});$iTXT.ui.HookManager={id:0,hookedCounter:0,textNodes:[],hooks:[],startIndex:0,unHookedHooks:[],initSkip:0,maxKWNode:5,maxKWPara:5,keywordPadding:0,keywordInterval:0,placePerParagraph:0,paragraphCounts:{},specialChars:{},nodeID:1,add:function(hook) {if(hook) {hook.id=this.id++;this.hooks.push(hook);}},get:function(id) {for(var i=1;i<this.hooks.length;i++) {var hk=this.hooks[i];if(hk.id==id) {return hk;}} return null;},list:function() {return this.hooks;},visibleHooks:function() {var i=0,n=this.hooks.length,a=[];for(;i<n;i++){if($itxtUtil.isElementVisible(this.hooks[i].rootElement)){a.push(this.hooks[i]);}} return a;},execute:function(tn) {this.setDefaultHookParameters();this.maxKWNode=Math.max(1,$iTXT.glob.params.getInt("kwpn",this.maxKWNode));this.maxKWPara=Math.max(1,$iTXT.glob.params.getInt("kwpp",this.maxKWPara));this.keywordPadding=$iTXT.glob.params.getInt("kwp",this.keywordPadding);this.keywordInterval=$iTXT.glob.params.getInt("hk.interval",this.keywordInterval);this.placePerParagraph=$iTXT.glob.params.getInt("ppp",this.placePerParagraph);this.initSkip=$iTXT.glob.params.getInt("skip",this.initSkip);$iTXT.debug.info($iTXT.debug.Category.HOOK,"Execute Hooking");$iTXT.debug.info($iTXT.debug.Category.HOOK,"ppp: "+this.placePerParagraph+", kwpn: "+this.maxKWNode+", kwpp: "+this.maxKWPara+", kwp: "+this.keywordPadding+", hk.interval: "+this.keywordInterval);if(!tn) {if(this.placePerParagraph&&$iTXT.data.Context.paragraphNodes.length>0) {tn=$iTXT.core.$A($iTXT.data.Context.paragraphNodes);$iTXT.debug.info($iTXT.debug.Category.HOOK,"Hooking in Paragraph Mode");} else {if(this.placePerParagraph) {$iTXT.debug.info($iTXT.debug.Category.HOOK,"No Paragraphs, Falling Back To Node Mode");} else {$iTXT.debug.info($iTXT.debug.Category.HOOK,"Hooking in Node Mode");} this.placePerParagraph=0;tn=$iTXT.core.$A($iTXT.data.Context.textNodes);}} tn=$iTXT.core.$A(tn);if(this.initSkip>0) {var sn=tn.splice(0,this.initSkip);var i=sn.length;$iTXT.debug.debug($iTXT.debug.Category.HOOK,'Skipping initial '+i+' out of '+(sn.length+tn.length)+((this.placePerParagraph)?' paragraphs':' nodes')+' (skip was '+this.initSkip+')');while(i--) {var sTn=($iTXT.core.Util.isArray(sn[i]))?sn[i]:[sn[i]];var j=sTn.length;while(j--) {$iTXT.debug.Util.hilite(sTn[j],$iTXT.debug.Util.HL_COL_INIT,null,true);}}} this.textNodes=$iTXT.core.$A(tn);for(var i=0;i<this.hooks.length;i++) {var hk=this.hooks[i];var hkad=hk.ad;if(hkad){var esc=hkad.params.get("js.special.hook.chars","").split(",");for(var i2=0;i2<esc.length;i2++) {this.specialChars[esc[i2]]=1;}}} this._findAllHooks();if(this.hooks.length>0) {this.textNodes.itxtEach(function(n) {if(this.placePerParagraph) {$iTXT.core.$A(n).itxtEach(function(pn) {var hks=this._getHooks(pn);if(hks.length>0) {this._hookNode(pn,hks);}},this);} else {var hks=this._getHooks(n);if(hks.length>0) {this._hookNode(n,hks);}}},this);} $iTXT.fire("$iTXT:hooks:loaded",this.hooks);},_findAllHooks:function() {this.unHookedHooks=this.hooks;this.hooks=[];if(this.unHookedHooks.length>0) {var track=$iTXT.glob.params.get("ti");if(null!=track) {$iTXT.debug.debug($iTXT.debug.Category.HOOK,"Dropping Channel Hook Tracking Image (ti): "+track);$iTXT.core.Util.dropImage(track);} if(this.placePerParagraph) {$iTXT.debug.info($iTXT.debug.Category.HOOK,"Finding Hooks: "+this.unHookedHooks.length+" hooks to find in "+this.textNodes.length+" hookable paragraphs.");} else {$iTXT.debug.info($iTXT.debug.Category.HOOK,"Finding Hooks: "+this.unHookedHooks.length+" hooks to find in "+this.textNodes.length+" hookable nodes.");} var nodesSinceHook=this.keywordInterval;var extraMask=0;this.textNodes.itxtEach(function(o) {if(this.placePerParagraph) {$iTXT.debug.info($iTXT.debug.Category.HOOK,"Searching Paragraph Containing "+o.length+" text nodes.");var pHookCount=0;$iTXT.core.$A(o).itxtEach(function(pn) {var sd=this._searchNode(pn,pHookCount,this.maxKWPara,extraMask,nodesSinceHook);var nc=sd.nc;extraMask=sd.lo;$iTXT.debug.info($iTXT.debug.Category.HOOK,"Found "+nc+" hooks in paragraph node.");pHookCount+=nc;},this);if(pHookCount>0) {nodesSinceHook=1;} else {nodesSinceHook++;}} else {var sd=this._searchNode(o,0,this.maxKWNode,extraMask,nodesSinceHook);var nc=sd.nc;$iTXT.debug.info($iTXT.debug.Category.HOOK,"Found "+nc+" hooks in node.");extraMask=sd.lo;if(nc>0) {nodesSinceHook=1;} else {nodesSinceHook++;}}},this);} else {$iTXT.debug.error($iTXT.debug.Category.HOOK,"No Hooks!!!!");}},_searchNode:function(n,nc,maxHooks,extraMask,nodesSinceLastHook) {if(nodesSinceLastHook<this.keywordInterval) {$iTXT.debug.debug($iTXT.debug.Category.HOOK,"Not hooking in Node as we hooked "+nodesSinceLastHook+" node(s)/paragraph(s) ago, and keyword node interval is "+this.keywordInterval);return{nc:0,lo:0};} var nodeHookCount=nc;var thisNC=0;var stillUnHooked=[];var nodeText=$iTXT.core.Util.getNodeText(n);$iTXT.debug.trace($iTXT.debug.Category.HOOK,"Searching Node: "+nodeText);var leftOverMask=0;extraMask=extraMask||0;if(extraMask>0) {$iTXT.debug.debug($iTXT.debug.Category.HOOK,extraMask+" characters extra masking carried over from previous node: ");var mask=this._maskHookText(0,extraMask,nodeText);nodeText=mask.text;leftOverMask=mask.leftover;} for(var i=0;i<this.unHookedHooks.length;i++) {var hk=this.unHookedHooks[i];if(null==hk.childSpans) {var found=false;$iTXT.debug.debug($iTXT.debug.Category.HOOK,"Looking For Hook: "+hk.options.value);if(nodeHookCount<maxHooks) {found=this._findHookByNode(hk,nodeText,n);} if(found) {$iTXT.debug.debug($iTXT.debug.Category.HOOK,"<b style='color: red'>Found Hook: "+hk.options.value+"</b>");this.hooks.push(hk);var mask=this._maskHookText(hk.details.s-this.keywordPadding,hk.details.e+this.keywordPadding,nodeText);nodeText=mask.text;leftOverMask=mask.leftover;nodeHookCount++;thisNC++;} else {stillUnHooked.push(hk);}}} this.unHookedHooks=stillUnHooked;return{nc:thisNC,lo:leftOverMask};},_maskHookText:function(s,e,text) {var maskStart=s;if(maskStart<0) maskStart=0;var maskEnd=e;var leftover=0;if(maskEnd>text.length) {leftover=maskEnd-text.length;maskEnd=text.length;} var rs=text.substring(0,maskStart);rs+=$iTXT.core.Util.strRepeat("#",maskEnd-maskStart);rs+=text.substring(maskEnd);$iTXT.debug.trace($iTXT.debug.Category.HOOK,"<b style='color: green'>Masking Text: '"+rs+"'</b> (from: '"+text+"')");return{text:rs,leftover:leftover};},_findHookByNode:function(hk,t,n) {var kw=hk.options.value;var okw=kw;var specialChar=(1===this.specialChars[okw]);kw=kw.replace(/(\+|\(|\.|\[|\-|\$|\<|\{|\%|\!|\)|\]|\?)/g,'\\$1');kw=kw.replace(/\ /g,'\\s+');var flags="gm";if(!hk.options.cs) {flags+="i";} var leftREChars="(\\b|\u201C|\u2018|\\s)",rightREChars="(\\b|\u201D|\\s|\\.|\\,|\\?|\\!)",pluralChars="(?:[\x27\u2019]s?)?";if(specialChar) {leftREChars="";rightREChars="";pluralChars="";} var kwRegEx=new RegExp(leftREChars+kw+rightREChars+pluralChars,flags);var match,foundHk=false,offset=0;while((match=kwRegEx.exec(t))&&!foundHk) {var kwMatch=match[0];if(kwMatch.length>0) {foundHk=true;} var he=(typeof(match.lastIndex)=='undefined'?kwRegEx.lastIndex:match.lastIndex);var kwl=kwMatch.length;var hs=he-kwl;if(1==$iTXT.glob.params.get('hk.cap.subterm',0)) {var kwS=hs,kwE=he;for(kwS=hs;kwS<kwE;kwS++) {if(!t.substr(kwS,1).match(/\s/)) {break;}} if(this._isCapitalisedSubTerm(t,kwS,kwE)) {foundHk=false;}} if(foundHk) {var hkLc=kwMatch.charAt(0);var hkRc=kwMatch.charAt(kwMatch.length-1);if(this._isNonBorderChar(hkLc)&&!specialChar) {hs++;kwl--;kwMatch=kwMatch.substring(1,kwMatch.length);} if(this._isNonBorderChar(hkRc)&&!specialChar) {he--;kwl--;kwMatch=kwMatch.substring(0,kwMatch.length-1);} var lc=t.substring(hs-1,hs);var rc=t.substring(he,he+1);if(!specialChar&&((lc=='-')||(lc.charCodeAt(0)==92)||(lc=='$')||(lc=='Â£')||(lc=='â¬')||(lc=='/')||(lc=='@')||(rc=='-'))) {foundHk=false;} if(!specialChar&&(((lc.charCodeAt(0)>127)&&(lc.charCodeAt(0)!=0x201C)&&(lc.charCodeAt(0)!=0x2018)&&(lc.charCodeAt(0)!=160))||((rc.charCodeAt(0)>127)&&(rc.charCodeAt(0)!=0x201D)&&(rc.charCodeAt(0)!=0x2019)&&(rc.charCodeAt(0)!=39)&&(rc.charCodeAt(0)!=8230)&&(rc.charCodeAt(0)!=160))||(/[a-z\u0600-\u06ff]/.test(lc)))) {foundHk=false;}} if(foundHk) {hk.details={n:n,s:hs+offset,e:he+offset,kw:kwMatch};} t=t.substring(he);offset+=he;kwRegEx.lastIndex=0;} return foundHk;},_hookNode:function(n,hks) {var newNodes=[];var pos=0;var text=$iTXT.core.Util.getNodeText(n);var followingText=text;hks.sort(function(a,b) {if(a.details&&b.details) {return(a.details.s-b.details.s);} return 0;});for(var i=0;i<hks.length;i++) {var hk=hks[i];hk.options.id=this.hookedCounter;hk.setKeyword(hk.details.kw);if(hk.details) {$iTXT.fire("$iTXT:hook:hooked",hk);$iTXT.debug.info($iTXT.debug.Category.HOOK,"Creating Hook: {0} (HTML_id: {1}, id:{2}, idh: {3}, start: {4})",hk.options.value,hk.options.id,hk.options.uid,hk.options.uidh,hk.options.s);var leadingText=document.createTextNode(text.substring(pos,hk.details.s));$iTXT.debug.debug($iTXT.debug.Category.HOOK,"Leading Text: "+leadingText.nodeValue);followingText=text.substring(hk.details.e,text.length);$iTXT.debug.debug($iTXT.debug.Category.HOOK,"Following Text: "+followingText);newNodes.push(leadingText);newNodes.push(hk.getHook());pos=hk.details.e;this.hookedCounter++;}} if(newNodes.length>0) {newNodes.push(document.createTextNode(followingText));var pNode=n.parentNode;if(pNode) {for(var i=0;i<newNodes.length;i++) {pNode.insertBefore(newNodes[i],n);} pNode.removeChild(n);}}},_getHooks:function(n) {var newArr=[];for(var i=0;i<this.hooks.length;i++) {var hk=this.hooks[i];if(hk.details.n==n) {newArr.push(hk);}} return newArr;},_isNonBorderChar:function(c) {return c==' '||c=='\n'||c=='\r'||c=='?'||c=='!'||c==','||c=='.'||c=='\u201C'||c=='\u2018';},_isCapitalisedSubTerm:function(t,s,e) {var kw=t.substring(s,e);if(!$iTXT.core.Util.hasCapitals(kw.substring(0,1))) {$iTXT.debug.debug($iTXT.debug.Category.HOOK,'<b>PASSED</b> keyword <b>"'+kw+'"</b> as it is itself not capitalised.');return false;} var ssS=Math.max(0,t.lastIndexOf(' ',s-2)+1);var ssE=Math.min(t.indexOf(' ',e+2),t.length);var bef=(s>ssS)?$iTXT.core.Util.cleanString(t.substring(ssS,s)):null;var aft=(ssE>e)?$iTXT.core.Util.cleanString(t.substring(e,ssE)):null;if(bef&&$iTXT.core.Util.hasPunctuation(bef.substr((bef.length-1),1))) {bef=null;} if(aft&&$iTXT.core.Util.hasPunctuation(aft.substr(0,1))) {aft=null;} var subT=t.substring(((s>ssS)?ssS:s),((ssE>e)?ssE:e));if((bef&&$iTXT.core.Util.hasCapitals(bef.substring(0,1)))||(aft&&$iTXT.core.Util.hasCapitals(aft.substring(0,1)))) {$iTXT.debug.debug($iTXT.debug.Category.HOOK,'<b>REJECTED</b> keyword <b>"'+kw+'"</b> as containing text <b>"'+subT+'"</b> has capitalised terms.');return true;} $iTXT.debug.debug($iTXT.debug.Category.HOOK,'<b>PASSED</b> keyword <b>"'+kw+'"</b> against containing text <b>"'+subT+'"</b>.');return false;},getNodeTag:function(o) {if(o&&o.nodeType) {var nT=o.nodeType;if($iTXT.core.Util.ELEMENT_NODE==nT) {if(o.ndPar) {return o.ndPar['this'];} o.ndPar=new Object();} else {var pn=o.parentNode;if($iTXT.core.Util.TEXT_NODE==nT) {if(o.parentNode.ndPar) {return o.parentNode.ndPar[$iTXT.core.Util.nodeIndex(o)];}}}} return null;},setDefaultHookParameters:function() {if($iTXT.glob.params) {var gps=$iTXT.glob.params;var wdb=$iTXT.cnst.WEIGHTING_DEFAULT_DATABASE;gps.set("hk.class","itxthook",wdb);gps.set("hk.class.active","itxthookactive",wdb);gps.set("hk.icon","",wdb);gps.set("hk.icon.active","",wdb);gps.set("hk.icon.path","http://images.intellitxt.com/ast/adTypes/",wdb);gps.set("fg","#006400",wdb);gps.set("bg","transparent",wdb);gps.set("hk.fg.col","${fg}",wdb);gps.set("hk.fg.h.col","#006400",wdb);gps.set("hk.bg.col","transparent",wdb);gps.set("hk.bg.h.col","${bg}",wdb);gps.set("hk.def.style","text-decoration: underline; border-bottom: 1px solid ${hk.fg.col}; border-top: none; color: ${hk.fg.col}; background-color: ${hk.bg.col}",wdb);gps.set("hk.def.h.style","text-decoration: underline; border-bottom: 0.2em solid ${hk.fg.h.col}; border-top: none; color: ${hk.fg.h.col}; background-color: ${hk.bg.h.col}",wdb);gps.set("hk.style","${hk.def.style}",wdb);gps.set("hk.h.style","${hk.def.h.style}",wdb);}}};$iTXT.ui.Hook=function(_options){return $iTXT.core.Util.delegateUI("Hook","hook",_options);};};$iTXT.js.loader["$iTXT.ui.LightboxChrome"]=true;$iTXT.ui.LightboxAVTrigger={ONBUFFER:0,ONOPEN:1,ONTIME:2};$iTXT.ui.LightboxChrome_Load=function(){var undefined;$iTXT.ui.LightboxChrome=$iTXT.core.Class.create($iTXT.ui.ComponentBase,{advert:null,init:function(_options,$super) {var defOpts=$iTXT.core.Util.extend({id:"itxtTakeoverAd",zIndex:$iTXT.core.Util.highestZIndex()+500},_options);$super(defOpts);},build:function() {var lightboxDiv=document.getElementById(this.options.id);if(lightboxDiv) {this.rootElement=lightboxDiv;} else {this.rootElement.wrapper=$iTXT.core.Builder.make("DIV",{id:"itxtLboxWrpr"});this.rootElement.wrapper.itxtSetStyle({marginTop:"-400px",position:"fixed",width:"100%",left:0,top:"50%",overflow:"hidden",zIndex:this.options.zIndex+500});this.rootElement.wrapper.itxtSubscribe("click",$iTXT.core.Event.bind(this,this._wrapperClick));this.rootElement.appendChild(this.rootElement.wrapper);var existingMask=document.getElementById("itxtLboxMask");if(!existingMask) {this.rootElement.mask=$iTXT.core.Builder.make("DIV",{id:"itxtLboxMask"},[]);this.rootElement.mask.itxtSetStyle({background:"#000",position:"fixed",top:"0px",left:"0px",width:"100%",height:"100%",zIndex:this.options.zIndex,overflow:"visible",opacity:0.8,filter:'alpha(opacity = 80)'});this.rootElement.iframe=$iTXT.core.Builder.make("iframe",{name:"itxtLboxWrprIframe",id:"itxtLboxWrprIframe",src:"about:blank",frameborder:0});this.rootElement.iframe.itxtSetStyle({background:'#444',position:"fixed",top:0,left:0,zIndex:this.options.zIndex-500,width:'100%',height:'100%'});this.rootElement.iframe.itxtHide();document.body.appendChild(this.rootElement.iframe);} else {this.rootElement.mask=existingMask;} this.rootElement.mask.itxtHide();this.rootElement.itxtHide();document.body.appendChild(this.rootElement.mask);document.body.appendChild(this.rootElement);}},fixOpacity:function() {var invalidObjects=0;var allowedWmode={transparent:true,opaque:true};var flashes=document.getElementsByTagName('object');var iframes=document.getElementsByTagName('iframe');if(flashes) {for(var f=0,fLen=flashes.length;f<fLen;f++) {var isAttrWmode=false;var isParamWmode=false;var thisFlash=flashes[f];if(thisFlash) {if(thisFlash.attributes) {for(var a=0,aLen=thisFlash.attributes.length;a<aLen;a++) {var thisAttr=thisFlash.attributes[a];if(thisAttr&&thisAttr.nodeValue&&!$iTXT.core.Util.isObject(thisAttr.nodeValue)&&allowedWmode[thisAttr.nodeValue]) {isAttrWmode=true;}}} if(thisFlash.childNodes) {for(var c=0,cLen=thisFlash.childNodes.length;c<cLen;c++) {var thisChild=thisFlash.childNodes[c];if(thisChild&&thisChild.name=="wmode"&&allowedWmode[thisChild.value]) {isParamWmode=true;}}}} if($iTXT.core.Browser.is("Explorer")&&!isParamWmode) {invalidObjects++;} else if(!(isAttrWmode||isParamWmode)) {invalidObjects++;}}} if(iframes) {for(var i=0,iLen=iframes.length;i<iLen;i++) {var thisFrame=iframes[i];if(thisFrame&&thisFrame.src&&thisFrame.src.indexOf('youtube.com')>0&&thisFrame.src.indexOf('wmode')==-1) {invalidObjects++;}}} if(invalidObjects>0) {$iTXT.debug.info($iTXT.debug.Category.GENERAL,"Incorect flash detected on the page. Switching to Lightbox solid-mask mode.");var solidMaskColor=this.advert.params.get('lbox.solidMaskColor','#444');this.rootElement.mask.itxtSetStyle({background:solidMaskColor,opacity:1,filter:'alpha(opacity=100)'});window.frames["itxtLboxWrprIframe"].document.body.style.backgroundColor=solidMaskColor;this.rootElement.iframe.itxtShow();}},_unitClick:function(e) {e.preventDefault();e.stop();},_wrapperClick:function(w) {$iTXT.fire("$iTXT:tt:lightbox:close",{isMaskClick:true});},_onMouseDownUp:function(e) {},show:function(ad) {this.advert=ad;this.fixOpacity();var overlaySrc=ad.params.get("lboxsrc");var _options={props:{src:overlaySrc,width:800,height:800},id:"lboxTakover"};var flash=new $iTXT.tmpl.Flash(_options,this.advert);var unit=$iTXT.core.Builder.make("DIV",{id:"itxtLboxUnit"},[flash.rootElement]);unit.itxtSetStyle({width:"800px",height:"800px",margin:"0 auto",zIndex:this.options.zIndex+1000});unit.itxtBatchSubscribe([["mouseup",$iTXT.core.Event.bind(this,this._onMouseDownUp)],["mousedown",$iTXT.core.Event.bind(this,this._onMouseDownUp)],["contextmenu",$iTXT.core.Event.bind(this,this._onMouseDownUp)],["click",$iTXT.core.Event.bind(this,this._unitClick)]],this.evtDspFuncs);this.rootElement.wrapper.itxtClear();this.rootElement.wrapper.appendChild(unit);this.rootElement.mask.itxtShow();this.rootElement.itxtShow();},hide:function() {if(!this.advert.flash){this.advert.flash=document.getElementById("lboxTakoverMC");} if(this.advert.flash) {try {flash.muteVideo();flash.reset();} catch(e) {}} this.rootElement.mask.itxtHide();this.rootElement.iframe.itxtHide();this.rootElement.itxtHide();}});};$iTXT.js.loader["$iTXT.ui.Tooltip"]=true;$iTXT.ui.Tooltip_Load=function(){var undefined;$iTXT.ui.TooltipPosition={AR:"AR",AL:"AL",BR:"BR",BL:"BL"};$iTXT.ui.SnapMode={Mouse:1,Text:0};$iTXT.ui.Tooltip=function(_options){return $iTXT.core.Util.delegateUI("Tooltip","chrome",_options);};};$iTXT.js.loader["$iTXT.ui.TooltipChrome"]=true;$iTXT.ui.TooltipChrome_Load=function(){$iTXT.ui.TooltipChrome=function(_options){return $iTXT.core.Util.delegateUI("TooltipChrome","chrome",_options);};};$iTXT.js.loader["$iTXT.ui.TooltipContent"]=true;$iTXT.ui.TooltipContent_Load=function(){var undefined;var loadingImage="http://images.intellitxt.com/ast/tt/09/loading.gif";$iTXT.core.Util.cacheImage(loadingImage);$iTXT.ui.TooltipContent=function(_options){return $iTXT.core.Util.delegateUI("TooltipContent","chrome",_options);};};$iTXT.js.loader["$iTXT.ui.TooltipDrawer"]=true;$iTXT.ui.TooltipDrawer_Load=function(){var undefined;$iTXT.ui.TooltipDrawer=function(_options){return $iTXT.core.Util.delegateUI("TooltipDrawer","chrome",_options);};};$iTXT.js.loader["$iTXT.ui.TooltipDrawerFooter"]=true;$iTXT.ui.TooltipDrawerFooter_Load=function(){var undefined;$iTXT.ui.TooltipDrawerFooter=function(_options){return $iTXT.core.Util.delegateUI("TooltipDrawerFooter","chrome",_options);};};$iTXT.js.loader["$iTXT.ui.TooltipFooter"]=true;$iTXT.ui.TooltipFooter_Load=function(){var undefined;$iTXT.ui.TooltipFooter=function(_options){return $iTXT.core.Util.delegateUI("TooltipFooter","chrome",_options);};};$iTXT.js.loader["$iTXT.ui.TooltipHeader"]=true;$iTXT.ui.TooltipHeader_Load=function(){$iTXT.ui.TooltipHeader=function(_options){return $iTXT.core.Util.delegateUI("TooltipHeader","chrome",_options);};};$iTXT.js.loader["$iTXT.ui.TooltipPlacer"]=true;$iTXT.ui=$iTXT.ui||{};$iTXT.ui.TooltipPlacer_Load=function(){var undefined;$iTXT.ui.TooltipPlacer={ttOffX:50,ttOffY:5,TOPOFFSCREENWEIGHT:20,EXPTOPOFFSCREENWEIGHT:20,OFFSCREENWEIGHT:15,EXPOFFSCREENWEIGHT:2,place:function(opts) {$iTXT.core.$(document).itxtFire("$iTXT:tt:before:position");$iTXT.debug.info($iTXT.debug.Category.PLACER,"Placing Tooltip");if(opts.bb&&opts.tt) {var ttW=opts.tt.width;var ttH=opts.tt.height;var bbL=opts.bb.left;var bbT=opts.bb.top;var bbR=opts.bb.left+opts.bb.width;var bbB=opts.bb.top+opts.bb.height;var ttps=$iTXT.ui.TooltipPosition;var posArr={};posArr[ttps.AR]={left:bbR-this.ttOffX,top:bbT-ttH-this.ttOffY,width:ttW,height:ttH,weight:0};posArr[ttps.AL]={left:bbL-ttW+this.ttOffX,top:bbT-ttH-this.ttOffY,width:ttW,height:ttH,weight:0};posArr[ttps.BR]={left:bbR-this.ttOffX,top:bbB+this.ttOffY,width:ttW,height:ttH,weight:0};posArr[ttps.BL]={left:bbL-ttW+this.ttOffX,top:bbB+this.ttOffY,width:ttW,height:ttH,weight:0};$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Possible Tooltip Placements:");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Above Right: "+$iTXT.core.Util.serialiseJSON(posArr[ttps.AR]));$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Above Left: "+$iTXT.core.Util.serialiseJSON(posArr[ttps.AL]));$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Below Right: "+$iTXT.core.Util.serialiseJSON(posArr[ttps.BR]));$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Below Left: "+$iTXT.core.Util.serialiseJSON(posArr[ttps.BL]));var sSize=$iTXT.core.Util.getWindowSize();var dScroll=$iTXT.core.Util.getPageScroll();var sb={left:dScroll[0],top:dScroll[1],width:sSize[0],height:sSize[1]};$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| SCREEN OVERLAP TEST a)");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Screen Bounds: "+$iTXT.core.Util.serialiseJSON(sb));posArr[ttps.AR].weight-=100*(1-$iTXT.core.Math.intersectsPercentage(posArr[ttps.AR],sb));posArr[ttps.AL].weight-=100*(1-$iTXT.core.Math.intersectsPercentage(posArr[ttps.AL],sb));posArr[ttps.BR].weight-=100*(1-$iTXT.core.Math.intersectsPercentage(posArr[ttps.BR],sb));posArr[ttps.BL].weight-=100*(1-$iTXT.core.Math.intersectsPercentage(posArr[ttps.BL],sb));$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Above Right Screen Overlap: "+($iTXT.core.Math.intersectsPercentage(posArr[ttps.AR],sb)*100)+"%");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Above Left Screen Overlap: "+($iTXT.core.Math.intersectsPercentage(posArr[ttps.AL],sb)*100)+"%");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Below Right Screen Overlap: "+($iTXT.core.Math.intersectsPercentage(posArr[ttps.BR],sb)*100)+"%");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Below Left Screen Overlap: "+($iTXT.core.Math.intersectsPercentage(posArr[ttps.BL],sb)*100)+"%");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Above Right Weight: "+posArr[ttps.AR].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Above Left Weight: "+posArr[ttps.AL].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Below Right Weight: "+posArr[ttps.BR].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Below Left Weight: "+posArr[ttps.BL].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| SCREEN OVERLAP TEST b)");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");var artd=((posArr[ttps.AR].top-sb.top));if(artd<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip off screen on top edge when Above Right by "+artd+"px");posArr[ttps.AR].weight+=this.TOPOFFSCREENWEIGHT*(artd/posArr[ttps.AR].height);} var artdExp=((posArr[ttps.AR].top-sb.top)-posArr[ttps.AR].height);if(artdExp<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Expanded tooltip off screen on top edge when Above Right by "+artdExp+"px");posArr[ttps.AR].weight+=this.EXPTOPOFFSCREENWEIGHT*(artdExp/posArr[ttps.AR].height);} var arrd=(((sb.left+sb.width)-(posArr[ttps.AR].left+posArr[ttps.AR].width)));if(arrd<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip off screen on right edge when Above Right by "+arrd+"px");posArr[ttps.AR].weight+=this.OFFSCREENWEIGHT*(arrd/posArr[ttps.AR].width);} var arrdExp=(((sb.left+sb.width)-(posArr[ttps.AR].left+posArr[ttps.AR].width))-posArr[ttps.AR].width);if(arrdExp<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Expanded Tooltip off screen on right edge when Above Right by "+arrdExp+"px");posArr[ttps.AR].weight+=this.EXPOFFSCREENWEIGHT*(arrdExp/posArr[ttps.AR].width);} var altd=((posArr[ttps.AL].top-sb.top));if(altd<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip off screen on top edge when Above Left by "+altd+"px");posArr[ttps.AL].weight+=this.TOPOFFSCREENWEIGHT*(altd/posArr[ttps.AL].height);} var altdExp=((posArr[ttps.AL].top-sb.top)-posArr[ttps.AL].height);if(altdExp<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Expanded tooltip off screen on top edge when Above Left by "+altdExp+"px");posArr[ttps.AL].weight+=this.EXPTOPOFFSCREENWEIGHT*(altdExp/posArr[ttps.AL].height);} var alld=((posArr[ttps.AL].left-sb.left));if(alld<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip off screen on left edge when Above Left by "+alld+"px");posArr[ttps.AL].weight+=this.OFFSCREENWEIGHT*(alld/posArr[ttps.AL].width);} var alldExp=((posArr[ttps.AL].left-sb.left)-posArr[ttps.AL].width);if(alldExp<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Expanded tooltip off screen on left edge when Above Left by "+alldExp+"px");posArr[ttps.AL].weight+=this.EXPOFFSCREENWEIGHT*(alldExp/posArr[ttps.AL].width);} var brbd=(((sb.top+sb.height)-(posArr[ttps.BR].top+posArr[ttps.BR].height)));if(brbd<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip off screen on bottom edge when Below Right by "+brbd+"px");posArr[ttps.BR].weight+=this.OFFSCREENWEIGHT*(brbd/posArr[ttps.BR].height);} var brbdExp=(((sb.top+sb.height)-(posArr[ttps.BR].top+posArr[ttps.BR].height))-posArr[ttps.BR].height);if(brbdExp<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Expanded tooltip offscreen on bottom edge when Below Right by "+brbdExp+"px");posArr[ttps.BR].weight+=this.EXPOFFSCREENWEIGHT*(brbdExp/posArr[ttps.BR].height);} var brrd=(((sb.left+sb.width)-(posArr[ttps.BR].left+posArr[ttps.BR].width)));if(brrd<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip offscreen on right edge when Below Right by "+brrd+"px");posArr[ttps.BR].weight+=this.OFFSCREENWEIGHT*(brrd/posArr[ttps.BR].width);} var brrdExp=(((sb.left+sb.width)-(posArr[ttps.BR].left+posArr[ttps.BR].width))-posArr[ttps.BR].width);if(brrdExp<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Expanded tooltip offscreen on right edge when Below Right by "+brrdExp+"px");posArr[ttps.BR].weight+=this.EXPOFFSCREENWEIGHT*(brrdExp/posArr[ttps.BR].width);} var blbd=(((sb.top+sb.height)-(posArr[ttps.BL].top+posArr[ttps.BL].height)));if(blbd<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip offscreen on bottom edge when Below Left by "+blbd+"px");posArr[ttps.BL].weight+=this.OFFSCREENWEIGHT*(blbd/posArr[ttps.BL].height);} var blbdExp=(((sb.top+sb.height)-(posArr[ttps.BL].top+posArr[ttps.BL].height))-posArr[ttps.BL].height);if(blbdExp<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Expanded tooltip offscreen on bottom edge when Below Left by "+blbdExp+"px");posArr[ttps.BL].weight+=this.EXPOFFSCREENWEIGHT*(blbdExp/posArr[ttps.BL].height);} var blrd=((posArr[ttps.BL].left-sb.left));if(blrd<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip offscreen on left edge when Below Left by "+blrd+"px");posArr[ttps.BL].weight+=this.OFFSCREENWEIGHT*(blrd/posArr[ttps.BL].width);} var blrdExp=((posArr[ttps.BL].left-sb.left)-posArr[ttps.BL].width);if(blrdExp<0) {$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Expanded tooltip offscreen on left edge when Below Left by "+blrdExp+"px");posArr[ttps.BL].weight+=this.EXPOFFSCREENWEIGHT*(blrdExp/posArr[ttps.BL].width);} $iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Above Right Weight: "+posArr[ttps.AR].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Above Left Weight: "+posArr[ttps.AL].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Below Right Weight: "+posArr[ttps.BR].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Below Left Weight: "+posArr[ttps.BL].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| SCREEN OVERLAP TEST c)");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");var scpos=$iTXT.core.Util.getPageScroll();var arTop=posArr[ttps.AR].top-sb.top+scpos[1];if(arTop<0) {posArr[ttps.AR].weight-=500;$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip header is off the top of the page when Above Right!!!");} var alTop=posArr[ttps.AL].top-sb.top+scpos[1];if(alTop<0) {posArr[ttps.AL].weight-=500;$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Tooltip header is off the top of the page when Above Left!!!");} $iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Above Right Weight: "+posArr[ttps.AR].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Above Left Weight: "+posArr[ttps.AL].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Below Right Weight: "+posArr[ttps.BR].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Below Left Weight: "+posArr[ttps.BL].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Avoidance Nodes Test");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");var avList=[{w:10,n:"IFRAME"},{w:10,n:"OBJECT"},{w:10,n:"EMBED"}];for(var i=0;i<avList.length;i++) {var avN=avList[i];var nLst=document.getElementsByTagName(avN.n);var nLstLen=nLst.length;$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Found "+nLstLen+" "+avN.n+" nodes");for(var i2=0;i2<nLstLen;i2++) {var nd=nLst[i2];var nbb=$iTXT.core.$(nd).itxtBounds();$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,avN.n+" node "+i2+" bounds: "+$iTXT.core.Util.serialiseJSON(nbb));posArr[ttps.AR].weight-=avN.w*($iTXT.core.Math.intersectsPercentage(posArr[ttps.AR],nbb));posArr[ttps.AL].weight-=avN.w*($iTXT.core.Math.intersectsPercentage(posArr[ttps.AL],nbb));posArr[ttps.BR].weight-=avN.w*($iTXT.core.Math.intersectsPercentage(posArr[ttps.BR],nbb));posArr[ttps.BL].weight-=avN.w*($iTXT.core.Math.intersectsPercentage(posArr[ttps.BL],nbb));$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Above Right Screen Overlap: "+($iTXT.core.Math.intersectsPercentage(posArr[ttps.AR],nbb)*100)+"%");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Above Left Screen Overlap: "+($iTXT.core.Math.intersectsPercentage(posArr[ttps.AL],nbb)*100)+"%");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Below Right Screen Overlap: "+($iTXT.core.Math.intersectsPercentage(posArr[ttps.BR],nbb)*100)+"%");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"Below Left Screen Overlap: "+($iTXT.core.Math.intersectsPercentage(posArr[ttps.BL],nbb)*100)+"%");}} $iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Above Right Weight: "+posArr[ttps.AR].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Above Left Weight: "+posArr[ttps.AL].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Below Right Weight: "+posArr[ttps.BR].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"| Below Left Weight: "+posArr[ttps.BL].weight);$iTXT.debug.debug($iTXT.debug.Category.PLACER,"------------------------------");var posState=ttps.AR;$iTXT.debug.info($iTXT.debug.Category.PLACER,"Choose Above Right position by default");if(posArr[ttps.AL].weight>posArr[posState].weight) {$iTXT.debug.info($iTXT.debug.Category.PLACER,"Above Left Has a Greater Weight");posState=ttps.AL;} if(posArr[ttps.BR].weight>posArr[posState].weight) {$iTXT.debug.info($iTXT.debug.Category.PLACER,"Below Right Has a Greater Weight");posState=ttps.BR;} if(posArr[ttps.BL].weight>posArr[posState].weight) {$iTXT.debug.info($iTXT.debug.Category.PLACER,"Below Left Has a Greater Weight");posState=ttps.BL;} if($iTXT.glob.params) {var dbgTTPS=$iTXT.glob.params.get("tt.pos.state");if(null!=dbgTTPS) {$iTXT.debug.info($iTXT.debug.Category.PLACER,"Forcing position state: "+dbgTTPS);posState=dbgTTPS;}} var returnOptions={left:posArr[posState].left,top:posArr[posState].top,state:posState};$iTXT.debug.info($iTXT.debug.Category.PLACER,"Return Position State: "+posState);$iTXT.debug.info($iTXT.debug.Category.PLACER,"Return Left Position: "+returnOptions.left);$iTXT.debug.info($iTXT.debug.Category.PLACER,"Return Top Position: "+returnOptions.top);return returnOptions;}}};};$iTXT.js.loader["$iTXT.ui.TooltipShadow"]=true;$iTXT.ui.TooltipShadow_Load=function(){$iTXT.ui.TooltipShadow=function(_options){return $iTXT.core.Util.delegateUI("TooltipShadow","chrome",_options);};};$iTXT.js.loader["$iTXT.ui.TooltipSlideOut"]=true;$iTXT.ui.TooltipSlideOut_Load=function(){$iTXT.ui.TooltipSlideOutDirection={LEFT:'L',RIGHT:'R',UP:'U',DOWN:'D'};$iTXT.ui.TooltipSlideOut=function(_options){return $iTXT.core.Util.delegateUI("TooltipSlideOut","chrome",_options);};};$iTXT.js.loader["$iTXT.ui.TooltipTail"]=true;$iTXT.ui.TooltipTail_Load=function(){$iTXT.ui.TooltipTail=function(_options){return $iTXT.core.Util.delegateUI("TooltipTail","chrome",_options);};}; ; 