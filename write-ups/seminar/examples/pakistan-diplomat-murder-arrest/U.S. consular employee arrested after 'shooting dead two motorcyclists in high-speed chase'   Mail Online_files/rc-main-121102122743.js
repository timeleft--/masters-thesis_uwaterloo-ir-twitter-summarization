DM.ReaderComments=(function(){var UI;var constructor=function(){var MAX_COMMENTS=10,MAX_COOKIE_RATINGS=50,defaultPaginationConfig,maxComments=MAX_COMMENTS,totalComments=0,offset=0,viewAll=false,rc,tabs,tabCommands=["newest","oldest","bestRated","worstRated"],tabNames=["newest","oldest","best","worst"],tabIndex=0,buttonLabel,ratingsCookie,abuseCookie,articleId,formId="readerCommentsCommand",userId,period,mode;new DM.FormValidator(formId,{custom_rules:{maxlength:{"if":{value1:"length",method:">",value2:1000},then:'error("You have exceeded the 1000 character limit for this field.")'},mandatoryHR:{"if":{value1:"value",method:"empty",value2:""},then:'error("You must agree to our House Rules to post a comment.")'},noEmail:{"if":{value1:"value",method:"matches",value2:/@/},then:"error(\"This field should not contain the following character: '@'.\")"}}});var articleCommentTemplate=new Ext.Template('<div id="comment-{commentId}" class="comment-post bogr1 bdrgr3 cleared"><p class="comment-body">{body}</p><p class="user-info bold">{userInfo}</p><div class="rating {ratingClass}" rel="{commentId}"><span class="gr5ox">Click to rate</span> <a class="js-rate js-rate-up rate-up" href="#">&nbsp;</a> <a class="js-rate js-rate-down rate-down" href="#">&nbsp;</a> <span>Rating</span> <span class="current-rating">&nbsp;</span> <span class="js-vote-rating vote-rating">{voteRating}</span></div>{abuseHTML}</div>').compile();var userCommentTemplate=new Ext.Template('<div id="comment-{commentId}" class="comment cleared"><p class="comment-title f-b"><a href="/reader-comments/p/comment/link/{commentId}">{articleTitle}</a></p><a class="comment-count" href="{articleUrl}#comments">Comments ({commentCount})</a><div class="comment-post"><p class="comment-body"><a href="/reader-comments/p/comment/link/{commentId}">{body}</a></p><div class="rating {ratingClass}" rel="{commentId}"><span class="gr5ox">Click to rate</span> <a class="js-rate js-rate-up rate-up" href="#">&nbsp;</a> <a class="js-rate js-rate-down rate-down" href="#">&nbsp;</a> <span>Rating</span> <span class="current-rating">&nbsp;</span> <span class="js-vote-rating vote-rating">{voteRating}</span></div>{abuseHTML}</div></div>').compile();var abuseTemplates={"link-gr5ox":new Ext.Template('<p class="js-report-abuse report-abuse link-gr5ox"><a href="{abuseLink}" rel="nofollow">Report abuse</a></p>').compile(),gr3ox:new Ext.Template('<p class="js-report-abuse report-abuse gr3ox">Report abuse</p>').compile()};var loadComments=function(config){var queryString="?max="+config.maxResults,tabSelected=tabCommands[tabIndex];if(config.offset){queryString+="&offset="+config.offset}if(config.period){queryString+="&period="+config.period}if(tabSelected=="newest"){queryString+="&order=desc"}else{if(tabSelected=="oldest"){queryString+="&order=asc"}else{if(tabSelected=="bestRated"){queryString+="&sort=voteRating&order=desc"}else{if(tabSelected=="worstRated"){queryString+="&sort=voteRating&order=asc"}}}}setButtonLabel("Loading...");if(config.mode==="article"){Ext.Ajax.request({url:"/reader-comments/p/asset/readcomments/"+articleId+queryString,callback:loadComments_callback,method:"get"})}else{if(config.mode==="user"){Ext.Ajax.request({url:"/reader-comments/p/user/readcomments/"+userId+queryString,callback:loadComments_callback,method:"get"})}}};var fromISOString=(function(){var tzOffset=(new Date).getTimezoneOffset();function dateParse(y,m,d,h,i,s,ms){return new Date(y,m-1,d,h||0,+(i||0)-tzOffset,s||0,ms||0)}return function(isoDateString){return dateParse.apply(null,isoDateString.split(/\D/))}})();var loadComments_callback=function(options,success,response){var m=Ext.util.JSON.decode(response.responseText),comments=(m&&m.payload&&m.payload.page)?m.payload.page:[],comment,dateStr="",tmp="",vr,ratingClass,cd;totalComments=(m.payload&&m.payload.total)?m.payload.total:totalComments;for(var i=0,len=comments.length;i<len;i++){comment=comments[i];if(comment.voteRating==0){vr="("+comment.voteRating+")";ratingClass=""}else{if(comment.voteRating>0){ratingClass="positive"}else{ratingClass="negative";comment.voteRating*=-1}vr=comment.voteRating}cd=new Date(comment.dateCreated);if(cd=="NaN"){cd=fromISOString(comment.dateCreated)}dateStr=cd.getDate();dateStr+="/"+(cd.getMonth()+1);dateStr+="/"+((cd.getYear()<1900)?cd.getYear()+1900:cd.getYear());dateStr+=" "+cd.getHours();dateStr+=":"+((cd.getMinutes()<10)?"0"+cd.getMinutes():cd.getMinutes());comment.userAliasUrl=(typeof comment.userAlias==="string")?comment.userAlias.replace(/ /g,"-")+"/":"";comment.userLocation=(typeof comment.userLocation==="string"&&comment.userLocation!=="default")?comment.userLocation+", ":"";if(mode==="article"){tmp+=articleCommentTemplate.apply({commentId:comment.id,body:comment.message,voteRating:vr,ratingClass:ratingClass+getRatingClass(comment.id),userInfo:'- <a href="/registration/'+comment.userIdentifier+"/"+comment.userAliasUrl+'profile.html" class="js-usr">'+comment.userAlias+"</a>, "+comment.userLocation+dateStr,abuseHTML:abuseTemplates[getAbuseClass(comment.id)].apply({abuseLink:"/home/reportAbuseInComment.html?articleId="+articleId+"&commentId="+comment.id})})}else{if(mode==="user"){tmp+=userCommentTemplate.apply({articleUrl:comment.assetUrl,articleTitle:comment.assetHeadline,commentId:comment.id,body:comment.message,voteRating:vr,ratingClass:ratingClass+getRatingClass(comment.id),userInfo:'- <a href="/registration/'+comment.userIdentifier+"/"+comment.userAlias+'/profile.html">'+comment.userAlias+"</a>, "+comment.userLocation+", "+dateStr,abuseHTML:abuseTemplates[getAbuseClass(comment.id)].apply({abuseLink:"/home/reportAbuseInComment.html?articleId="+comment.assetId+"&commentId="+comment.id}),commentCount:comment.assetCommentCount})}}}Ext.get("js-comments").dom.innerHTML=tmp;if(viewAll){setButtonLabel("View "+tabNames[tabIndex]+" "+maxComments);DM.Pagination.getInstance().doPagination(m.payload)}else{setButtonLabel("View all");DM.Pagination.getInstance().hide()}if(totalComments>maxComments){Ext.get("js-view-all-link").removeClass("hidden")}if(comments.length>=0){Ext.each(Ext.query("div.rc-content",rc),function(el){Ext.fly(el).removeClass("hidden")})}};var toggleViewAll=function(pageConfig){viewAll=!viewAll;if(viewAll){loadComments(pageConfig)}else{loadComments({maxResults:maxComments,page:1,mode:mode,period:period})}};var readerCommentsHandler=function(e,t){var elTarget=e.getTarget("#js-view-all-link",4,true),rel;if(elTarget){intellitrackerLog();toggleViewAll(defaultPaginationConfig);e.stopEvent();return}else{if(elTarget=e.getTarget(".js-usr",3,true)){if(!DM.isLoggedIn&&DM.Login){e.preventDefault();DM.Login.open(e,t,{params:{url:"/registration/p/lightbox_login.html?usr=1&targetUrl="+encodeURIComponent(elTarget.dom.href)}})}}else{if(elTarget=e.getTarget("a.js-rate",3,true)){var ratingEl=Ext.get(elTarget.dom.parentNode);var voteRating=Ext.query("span.js-vote-rating",Ext.getDom(ratingEl))[0].innerHTML;if(!ratingEl.hasClass("rated")){if(elTarget.hasClass("js-rate-up")){rel=ratingEl.dom.getAttribute("rel");Ext.Ajax.request({method:"POST",url:"/reader-comments/p/comment/voteup/"+rel,success:function(){ratingEl.addClass("rated rated-up");updateRatingsCookie(rel,"+");if(voteRating.indexOf("(0)")!=-1){voteRating=1}else{if(ratingEl.hasClass("negative")){voteRating=parseInt(voteRating)-1}else{voteRating=parseInt(voteRating)+1}}updateRatingCount(ratingEl,voteRating)}})}else{if(elTarget.hasClass("js-rate-down")){rel=ratingEl.dom.getAttribute("rel");Ext.Ajax.request({method:"POST",url:"/reader-comments/p/comment/votedown/"+rel,success:function(){ratingEl.addClass("rated rated-down");updateRatingsCookie(rel,"-");if(voteRating.indexOf("(0)")!=-1){voteRating=-1}else{if(ratingEl.hasClass("negative")){voteRating=(parseInt(voteRating)+1)*-1}else{voteRating=parseInt(voteRating)-1}}updateRatingCount(ratingEl,voteRating)}})}}}e.stopEvent()}else{if(elTarget=e.getTarget(".js-more-link",3,true)){var containerEl=elTarget.parent(".js-headers").child(".comments-user");if(!containerEl){return}elTarget.containerHeight=elTarget.containerHeight||containerEl.getHeight();containerEl.scale(undefined,elTarget.hasClass("js-collapsed")?elTarget.containerHeight:0,{easing:"easeOut",duration:0.65});elTarget.toggleClass("js-collapsed");e.stopEvent()}}}}};var checkCookies=function(){var arrComments,currentComment,arrAbuseLink,currentAbuseLink;if(ratingsCookie){arrComments=Ext.query("div.comment-post",rc);for(var i=0,len=arrComments.length;i<len;i++){currentComment=arrComments[i];currentComment.rating=currentComment.getElementsByTagName("div")[0];currentComment.commentId=currentComment.rating.getAttribute("rel");if(ratingsCookie.search(eval("/"+currentComment.commentId+"[+-]/"))!=-1){Ext.fly(currentComment.rating).addClass(getRatingClass(currentComment.commentId))}}}if(abuseCookie){arrComments=Ext.query("div.comment-post",rc);arrAbuseLink=Ext.query("p.js-report-abuse",rc);for(var i=0,len=arrComments.length;i<len;i++){currentComment=arrComments[i];currentAbuseLink=arrAbuseLink[i];currentComment.rating=currentComment.getElementsByTagName("div")[0];currentComment.commentId=currentComment.rating.getAttribute("rel");if(abuseCookie.search(eval(currentComment.commentId))!=-1){currentAbuseLink.innerHTML=currentAbuseLink.getElementsByTagName("a")[0].innerHTML;Ext.fly(currentAbuseLink).replaceClass("link-gr5ox",getAbuseClass(currentComment.commentId))}}}};var updateRatingsCookie=function(messageId,upOrDown){var arrRatingsCookie=(ratingsCookie)?ratingsCookie.split(","):[];if(arrRatingsCookie.push(messageId+upOrDown)>MAX_COOKIE_RATINGS){arrRatingsCookie=arrRatingsCookie.slice(1)}var expireDate=new Date();expireDate.setFullYear(2030);ratingsCookie=arrRatingsCookie.join(",");DM.setCookie("commentRatings",ratingsCookie,expireDate,"/")};var updateRatingCount=function(ratingEl,voteRating){var voteRatingEl=Ext.query("span.js-vote-rating",ratingEl.dom)[0];if(voteRating==0){ratingEl.removeClass(["positive","negative"]);voteRatingEl.innerHTML="(0)"}else{if(voteRating>0){ratingEl.addClass("positive")}else{voteRating*=-1;ratingEl.addClass("negative")}voteRatingEl.innerHTML=voteRating}};var getRatingClass=function(commentId){if(ratingsCookie){var match=new RegExp(commentId+"([+-])").exec(ratingsCookie);if(match){switch(match[1]){case"+":return" rated rated-up";case"-":return" rated rated-down"}}}return""};var updateAbuseCookie=function(commentId){var arrAbuseCookie=(abuseCookie)?abuseCookie.split(","):[];if(arrAbuseCookie.push(commentId)>MAX_COOKIE_RATINGS){arrAbuseCookie=arrAbuseCookie.slice(1)}var expireDate=new Date();expireDate.setFullYear(2030);abuseCookie=arrAbuseCookie.join(",");DM.setCookie("reportAbuse",abuseCookie,expireDate,"/")};var getAbuseClass=function(commentId){return(abuseCookie&&abuseCookie.search(commentId+"")!=-1)?"gr3ox":"link-gr5ox"};var setFormValuesFromCookie=function(){var formEl=Ext.query("form.post-comment-form","reader-comments")[0];if(typeof formEl!="undefined"){if(DM.getCookie("remember_me_cookie")&&typeof formEl.rememberMe!="undefined"){formEl.rememberMe.checked=true}if(DM.getCookie("reader_name_cookie")&&typeof formEl.name!="undefined"){formEl.name.value=DM.getCookie("reader_name_cookie")}if(DM.getCookie("reader_town_cookie")&&typeof formEl.townAndCountry!="undefined"){formEl.townAndCountry.value=DM.getCookie("reader_town_cookie")}}};var setButtonLabel=function(text){if(buttonLabel){buttonLabel.innerHTML=text}};var tabHandler=function(e){var trg=e.getTarget("li.dm-tab",5),l=tabs._tabs.length;while(0<l){l--;if(trg==tabs._tabs[l]){tabIndex=l}}tabs._selectTab(trg);viewAll=true;intellitrackerLog();toggleViewAll(defaultPaginationConfig)};var intellitrackerLog=function(){DM.Omniture.log({prop4:"comment-tab"});DM.ComScore.logPE({name:DM.ComScore.labels.name.replace(/.page$/gi,".comment.page"),mo_vs_ct:"cc",mo_ev_ty:"page",mo_ev_ac:"comment",mo_ev_mt:"tab-"+((tabs!==undefined)?tabs._tabs[tabIndex].innerHTML.toLowerCase().replace(/(<[^>]+>|\s)/ig,""):"page")})};return{init:function(obj){var params=obj.params||{},articleIdMatch=null,userIdMatch=null,hashCommentId;totalComments=params.total||0;mode=params.mode||"article";ratingsCookie=DM.getCookie("commentRatings");abuseCookie=DM.getCookie("reportAbuse");var r=Ext.get(obj.id);if(r){rc=r.dom}if(rc){if(mode==="article"){articleIdMatch=new RegExp("article-id-([0-9]+)").exec(rc.className);articleId=(articleIdMatch)?articleIdMatch[1]:null}else{if(mode==="user"){userIdMatch=new RegExp("user-id-([0-9]+)").exec(rc.className);userId=(userIdMatch)?userIdMatch[1]:null}}defaultPaginationConfig={maxResults:100,page:1,offset:0,articleId:articleId,userId:userId,greyStyle:true,mode:mode,numberOfPageButtonsToShow:10};if(mode==="user"){period=params.period||"week";defaultPaginationConfig.period=period;defaultPaginationConfig.numberOfPageButtonsToShow=5}DM.Pagination.getInstance().init(loadComments,defaultPaginationConfig);Ext.get("reader-comments").on("click",readerCommentsHandler,this);checkCookies();var rcTabs=Ext.get("rc-tabs");if(rcTabs){tabs=new DM.RCTabs("reader-comments",{tabOnClass:["ow-igr5-bx wogr5","link-wox","dm-tab-on"],tabOffClass:["ow-igr2-bx","xogr2","link-gr5ox"],tabQuery:"li",_clickHandler:tabHandler})}if(Ext.get("js-view-all-link")){buttonLabel=Ext.get("js-view-all-link").dom.getElementsByTagName("span")[1]}if(mode==="article"){hashCommentId=window.location.hash.substring(1).match(/(comment\-\d+)/);hashCommentId=hashCommentId?hashCommentId[1]:null;if(hashCommentId){viewAll=true;setButtonLabel("View "+tabNames[tabIndex]+" "+maxComments);DM.Pagination.getInstance().doPagination({max:100,offset:params.offset||0,total:totalComments});Ext.get(hashCommentId).replaceClass("bogr1","bogr2")}}setFormValuesFromCookie()}if(Ext.get("report-abuse-comfirm")){updateAbuseCookie(Ext.get("report-abuse-comfirm").dom.className.split("|")[0])}}}};return{getInstance:function(){if(!UI){UI=constructor()}return UI}}})();DM.RCTabs=Ext.extend(Ext.util.Observable,{linkHk:".js-links",activeHk:"js-active",tabsQuery:".dm-tab",tabOffClass:null,tabOnClass:null,constructor:function(b,a){DM.RCTabs.superclass.constructor.call(this);a&&Ext.apply(this,a);this.el=Ext.get(b);Ext.fly(this.el.query(this.linkHk)[0]).on("click",this._clickHandler,this,{preventDefault:true});this._tabs=this.el.query(this.tabsQuery)},_clickHandler:function(a){},_selectTab:function(a){this.reset();this.tab(a)},reset:function(){var b;var a=this._tabs.length;while(a>0){--a;b=Ext.get(this._tabs[a]);b.addClass(this.tabOffClass).removeClass(this.tabOnClass).removeClass(this.activeHk)}},tab:function(a){Ext.fly(a).removeClass(this.tabOffClass).addClass(this.tabOnClass).addClass(this.activeHk)}});DM.Pagination=function(){var b;function a(){var d,e,c={maxResults:100,offset:0,page:1,showPageNumber:true,showPagingOptions:false,greyStyle:false,numberOfPageButtonsToShow:10};function f(h){h.stopEvent();var g=h.getTarget("A",5);if(g){c.page=parseInt(g.getAttribute("rel"));c.offset=parseInt(c.page-1)*c.maxResults;e(c)}}return{init:function(h,g){e=h;Ext.apply(c,g);d=Ext.query("div.pagination-container","content");Ext.each(d,function(i){Ext.fly(i).on("click",f)})},doPagination:function(t){if(typeof t!=="object"){return}var o=parseInt(t.max),j=parseInt(t.offset),u=parseInt(t.total),q=c.numberOfPageButtonsToShow,r=Math.ceil(u/o),p=parseInt(j/o),m=1+p,w=[],s=[];for(var h=1;h<q;h++){if(m>1&&(m-h>0)){w.push(m-h)}if(w.length+s.length>=q-1){break}if((m+h)<=r){s.push(m+h)}if(w.length+s.length>=q-1){break}}if(r>1&&d.length>0){var v="";var g=["","","","",""];var l="link-ccox";var k="<span>Page</span>";if(c.showPageNumber){v+='<div class="sch-pagesummary">Page '+m+" of "+r+"</div>"}if(m>1){g[0]='<a href="#" rel="'+(m-1)+'">Previous</a>'}for(var h=w.length-1;h>=0;h--){g[1]+='<a class="page-number bdrgr3" href="#" rel="'+w[h]+'">'+w[h]+"</a>"}g[2]='<span class="page-number bdrgr3 bogr2">'+m+"</span>";for(var h=0;h<s.length;h++){g[3]+='<a class="page-number bdrgr3" href="#" rel="'+s[h]+'">'+s[h]+"</a>"}if(m<r){g[4]='<a href="#" rel="'+(m+1)+'">Next</a>'}if(c.greyStyle){l="link-gr5ox";k=""}v+='<div class="pagination bdrcc '+l+' linkro-box"><div class="float-r">'+k+g.join("")+"</div></div>";for(var h=0,n=d.length;h<n;h++){d[h].innerHTML=v;Ext.fly(d[h]).setStyle("display","block")}}else{this.hide()}},hide:function(){for(var h=0,g=d.length;h<g;h++){Ext.fly(d[h]).setStyle("display","none")}}}}return{getInstance:function(){if(!b){b=a()}return b}}}();